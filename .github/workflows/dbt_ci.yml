# ============================================================================
# DBT CI PIPELINE
# ============================================================================
# Runs dbt build on every pull request.
# ============================================================================

name: dbt CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  DBT_PROFILES_DIR: ./

jobs:
  dbt-build:
    name: dbt build
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ecommerce_dw
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install dbt-postgres

      - name: Create CI profile
        run: |
          cat <<EOF > profiles.yml
          ecommerce_dbt:
            target: ci
            outputs:
              ci:
                type: postgres
                host: localhost
                port: 5432
                user: postgres
                password: postgres
                dbname: ecommerce_dw
                schema: analytics
                threads: 4
          EOF

      - name: Create schemas
        run: |
          PGPASSWORD=postgres psql -h localhost -U postgres -d ecommerce_dw -c "CREATE SCHEMA IF NOT EXISTS staging;"
          PGPASSWORD=postgres psql -h localhost -U postgres -d ecommerce_dw -c "CREATE SCHEMA IF NOT EXISTS warehouse;"
          PGPASSWORD=postgres psql -h localhost -U postgres -d ecommerce_dw -c "CREATE SCHEMA IF NOT EXISTS analytics;"
          PGPASSWORD=postgres psql -h localhost -U postgres -d ecommerce_dw -c "CREATE SCHEMA IF NOT EXISTS snapshots;"

      - name: Load seed data
        working-directory: ./ecommerce_dbt
        run: dbt seed

      - name: Run dbt build
        working-directory: ./ecommerce_dbt
        run: dbt build

      - name: Generate docs
        working-directory: ./ecommerce_dbt
        run: dbt docs generate
